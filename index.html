<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>Stronglifts 5x5</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- PWA-manifest -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#111827" />

  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      background: #0f172a;
      color: #e5e7eb;
    }
    .app {
      max-width: 480px;
      margin: 0 auto;
      padding: 16px;
    }
    h1 {
      font-size: 24px;
      text-align: center;
      margin-bottom: 8px;
    }
    .sub {
      font-size: 14px;
      text-align: center;
      color: #9ca3af;
      margin-bottom: 16px;
    }
    .pass-toggle {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    .pass-button {
      flex: 1;
      padding: 10px 0;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #111827;
      color: #e5e7eb;
      font-size: 15px;
    }
    .pass-button.active {
      background: #22c55e;
      color: #111827;
      border-color: #22c55e;
      font-weight: 600;
    }
    .card {
      background: #020617;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
      border: 1px solid #1f2937;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 8px;
    }
    .exercise-name {
      font-weight: 600;
      font-size: 16px;
    }
    .exercise-meta {
      font-size: 13px;
      color: #9ca3af;
    }
    .weight-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .weight-label {
      font-size: 14px;
      color: #9ca3af;
    }
    .weight-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .weight-value {
      min-width: 60px;
      text-align: center;
      font-size: 16px;
    }
    .btn-circle {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #111827;
      color: #e5e7eb;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .btn-circle:active {
      background: #1f2937;
    }
    .sets-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .set-pill {
      flex: 1;
      min-width: 40px;
      padding: 6px 0;
      text-align: center;
      border-radius: 999px;
      border: 1px solid #4b5563;
      font-size: 14px;
      background: #020617;
      color: #e5e7eb;
    }
    .set-pill.done {
      background: #22c55e;
      color: #111827;
      border-color: #22c55e;
      font-weight: 600;
    }
    .footer-actions {
      margin-top: 16px;
      display: flex;
      gap: 8px;
    }
    .footer-button {
      flex: 1;
      padding: 12px 0;
      border-radius: 999px;
      border: none;
      font-size: 15px;
      font-weight: 600;
    }
    .footer-button.primary {
      background: #22c55e;
      color: #111827;
    }
    .footer-button.secondary {
      background: #111827;
      color: #e5e7eb;
      border: 1px solid #4b5563;
    }
    .info {
      margin-top: 12px;
      font-size: 12px;
      color: #6b7280;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>Stronglifts 5×5</h1>
    <div class="sub">Välj pass, markera reps, justera vikter</div>

    <div class="pass-toggle">
      <button id="btn-pass-a" class="pass-button">Pass A</button>
      <button id="btn-pass-b" class="pass-button">Pass B</button>
    </div>

    <div id="exercise-list"></div>

    <div class="footer-actions">
      <button id="btn-reset" class="footer-button secondary">Återställ set</button>
      <button id="btn-complete" class="footer-button primary">Slutför pass</button>
    </div>

    <div class="info">
      Appen sparar vikter, reps och senaste pass lokalt på varje telefon.
    </div>
  </div>

  <script>
    // ----- Konfiguration -----
    const WORKOUTS = {
      A: [
        { id: 'squat', name: 'Knäböj', sets: 5, reps: 5 },
        { id: 'bench', name: 'Bänkpress', sets: 5, reps: 5 },
        { id: 'row',   name: 'Skivstångsrodd', sets: 5, reps: 5 },
      ],
      B: [
        { id: 'squat',  name: 'Knäböj', sets: 5, reps: 5 },
        { id: 'ohp',    name: 'Militärpress', sets: 5, reps: 5 },
        { id: 'dead',   name: 'Marklyft', sets: 1, reps: 5 },
      ],
    };

    const DEFAULT_WEIGHTS = {
      squat: 20,
      bench: 20,
      row:   20,
      ohp:   20,
      dead:  40,
    };

    const INCREMENTS = {
      default: 2.5,
      dead: 5,
    };

    const STORAGE_KEY_STATE = 'sl5x5_state_v2';

    let state = {
      currentPass: 'A',
      weights: { ...DEFAULT_WEIGHTS },
      // repsLeft: { 'A_squat': [5,5,5,5,5], ... }
      repsLeft: {},
    };

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY_STATE);
        if (raw) {
          const parsed = JSON.parse(raw);
          state = {
            ...state,
            ...parsed,
            weights: { ...DEFAULT_WEIGHTS, ...(parsed.weights || {}) },
            repsLeft: parsed.repsLeft || {},
          };
        }
      } catch (e) {
        console.error('Kunde inte läsa state', e);
      }
    }

    function saveState() {
      try {
        localStorage.setItem(STORAGE_KEY_STATE, JSON.stringify(state));
      } catch (e) {
        console.error('Kunde inte spara state', e);
      }
    }

    const exerciseListEl = document.getElementById('exercise-list');
    const btnPassA = document.getElementById('btn-pass-a');
    const btnPassB = document.getElementById('btn-pass-b');
    const btnReset = document.getElementById('btn-reset');
    const btnComplete = document.getElementById('btn-complete');

    function render() {
      // Markera aktivt pass
      btnPassA.classList.toggle('active', state.currentPass === 'A');
      btnPassB.classList.toggle('active', state.currentPass === 'B');

      // Rendera övningar
      exerciseListEl.innerHTML = '';
      const workout = WORKOUTS[state.currentPass];

      workout.forEach(ex => {
        const card = document.createElement('div');
        card.className = 'card';

        const header = document.createElement('div');
        header.className = 'card-header';

        const nameEl = document.createElement('div');
        nameEl.className = 'exercise-name';
        nameEl.textContent = ex.name;

        const metaEl = document.createElement('div');
        metaEl.className = 'exercise-meta';
        metaEl.textContent = `${ex.sets}×${ex.reps}`;

        header.appendChild(nameEl);
        header.appendChild(metaEl);

        const weightRow = document.createElement('div');
        weightRow.className = 'weight-row';

        const weightLabel = document.createElement('div');
        weightLabel.className = 'weight-label';
        weightLabel.textContent = 'Vikt (kg)';

        const weightControls = document.createElement('div');
        weightControls.className = 'weight-controls';

        const minusBtn = document.createElement('button');
        minusBtn.className = 'btn-circle';
        minusBtn.textContent = '−';
        minusBtn.addEventListener('click', () => {
          state.weights[ex.id] = Math.max(0, (state.weights[ex.id] || 0) - 2.5);
          saveState();
          render();
        });

        const weightValue = document.createElement('div');
        weightValue.className = 'weight-value';
        weightValue.textContent = (state.weights[ex.id] ?? 0).toFixed(1).replace('.0','');

        const plusBtn = document.createElement('button');
        plusBtn.className = 'btn-circle';
        plusBtn.textContent = '+';
        plusBtn.addEventListener('click', () => {
          state.weights[ex.id] = (state.weights[ex.id] || 0) + 2.5;
          saveState();
          render();
        });

        weightControls.appendChild(minusBtn);
        weightControls.appendChild(weightValue);
        weightControls.appendChild(plusBtn);

        weightRow.appendChild(weightLabel);
        weightRow.appendChild(weightControls);

        const setsRow = document.createElement('div');
        setsRow.className = 'sets-row';

        const key = `${state.currentPass}_${ex.id}`;
        const repsArray = state.repsLeft[key] || Array(ex.sets).fill(ex.reps);

        repsArray.forEach((reps, index) => {
          const pill = document.createElement('button');
          pill.className = 'set-pill' + (reps === 0 ? ' done' : '');
          pill.textContent = reps.toString();
          pill.addEventListener('click', () => {
            const updated = [...repsArray];
            updated[index] = Math.max(0, updated[index] - 1);
            state.repsLeft[key] = updated;
            saveState();
            render();
          });
          setsRow.appendChild(pill);
        });

        card.appendChild(header);
        card.appendChild(weightRow);
        card.appendChild(setsRow);

        exerciseListEl.appendChild(card);
      });
    }

    function resetSets() {
      const workout = WORKOUTS[state.currentPass];
      workout.forEach(ex => {
        const key = `${state.currentPass}_${ex.id}`;
        delete state.repsLeft[key];
      });
      saveState();
      render();
    }

    function completeWorkout() {
      const workout = WORKOUTS[state.currentPass];
      let allCompleted = true;

      workout.forEach(ex => {
        const key = `${state.currentPass}_${ex.id}`;
        const repsArray = state.repsLeft[key] || Array(ex.sets).fill(ex.reps);
        if (!repsArray.every(r => r === 0)) {
          allCompleted = false;
        }
      });

      if (allCompleted) {
        workout.forEach(ex => {
          const inc = ex.id === 'dead' ? INCREMENTS.dead : INCREMENTS.default;
          state.weights[ex.id] = (state.weights[ex.id] || 0) + inc;
        });
      }

      resetSets();
      state.currentPass = state.currentPass === 'A' ? 'B' : 'A';

      saveState();
      render();
      alert(allCompleted ? 'Pass klart! Vikterna har ökats där alla set var klara.' : 'Pass slutfört. Några set var ej klara, vikter oförändrade.');
    }

    btnPassA.addEventListener('click', () => {
      state.currentPass = 'A';
      saveState();
      render();
    });

    btnPassB.addEventListener('click', () => {
      state.currentPass = 'B';
      saveState();
      render();
    });

    btnReset.addEventListener('click', () => {
      if (confirm('Återställ alla set för aktuellt pass?')) {
        resetSets();
      }
    });

    btnComplete.addEventListener('click', () => {
      completeWorkout();
    });

    loadState();
    render();

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .catch(err => console.error('SW error', err));
      });
    }
  </script>
</body>
</html>
