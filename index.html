<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>Stronglifts 5x5</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#111827" />
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      background: #0f172a;
      color: #e5e7eb;
    }
    .app {
      max-width: 480px;
      margin: 0 auto;
      padding: 16px;
    }
    h1 {
      font-size: 24px;
      text-align: center;
      margin-bottom: 8px;
    }
    .sub {
      font-size: 14px;
      text-align: center;
      color: #9ca3af;
      margin-bottom: 16px;
    }
    .pass-toggle {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    .pass-button {
      flex: 1;
      padding: 10px 0;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #111827;
      color: #e5e7eb;
      font-size: 15px;
    }
    .pass-button.active {
      background: #22c55e;
      color: #111827;
      border-color: #22c55e;
      font-weight: 600;
    }
    .global-timer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
    }
    .global-timer-label {
      font-weight: 500;
    }
    .global-timer-value {
      font-variant-numeric: tabular-nums;
    }
    .card {
      background: #020617;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
      border: 1px solid #1f2937;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 8px;
    }
    .exercise-name {
      font-weight: 600;
      font-size: 16px;
    }
    .exercise-meta {
      font-size: 13px;
      color: #9ca3af;
    }
    .weight-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }
    .weight-label {
      font-size: 14px;
      color: #9ca3af;
    }
    .weight-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .weight-value {
      min-width: 60px;
      text-align: center;
      font-size: 16px;
    }
    .btn-circle {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #111827;
      color: #e5e7eb;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .btn-circle:active {
      background: #1f2937;
    }
    .sets-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .set-pill {
      flex: 1;
      min-width: 40px;
      padding: 6px 0;
      text-align: center;
      border-radius: 999px;
      border: 1px solid #4b5563;
      font-size: 14px;
      background: #020617;
      color: #e5e7eb;
    }
    .set-pill.done {
      background: #22c55e;
      color: #111827;
      border-color: #22c55e;
      font-weight: 600;
    }
    .footer-actions {
      margin-top: 16px;
      display: flex;
      gap: 8px;
    }
    .footer-button {
      flex: 1;
      padding: 12px 0;
      border-radius: 999px;
      border: none;
      font-size: 15px;
      font-weight: 600;
    }
    .footer-button.primary {
      background: #22c55e;
      color: #111827;
    }
    .footer-button.secondary {
      background: #111827;
      color: #e5e7eb;
      border: 1px solid #4b5563;
    }
    .info {
      margin-top: 12px;
      font-size: 12px;
      color: #6b7280;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>Stronglifts 5×5</h1>
    <div class="sub">Välj pass, markera reps, justera vikter</div>

    <div class="pass-toggle">
      <button id="btn-pass-a" class="pass-button">Pass A</button>
      <button id="btn-pass-b" class="pass-button">Pass B</button>
    </div>

    <div id="global-timer" style="display:none;" class="global-timer">
      <div class="global-timer-label" id="global-timer-label"></div>
      <div class="global-timer-value" id="global-timer-value">00:00</div>
    </div>

    <div id="exercise-list"></div>

    <div class="footer-actions">
      <button id="btn-reset" class="footer-button secondary">Återställ set</button>
      <button id="btn-complete" class="footer-button primary">Slutför pass</button>
    </div>

    <div class="info">
      Appen sparar vikter, reps och senaste pass lokalt på varje telefon. Timern är bara visuell och sparas inte.
    </div>
  </div>

  <script>
    const WORKOUTS = {
      A: [
        { id: 'squat', name: 'Knäböj', sets: 5, reps: 5 },
        { id: 'bench', name: 'Bänkpress', sets: 5, reps: 5 },
        { id: 'row',   name: 'Skivstångsrodd', sets: 5, reps: 5 },
      ],
      B: [
        { id: 'squat',  name: 'Knäböj', sets: 5, reps: 5 },
        { id: 'ohp',    name: 'Militärpress', sets: 5, reps: 5 },
        { id: 'dead',   name: 'Marklyft', sets: 1, reps: 5 },
      ],
    };

    const DEFAULT_WEIGHTS = {
      squat: 20,
      bench: 20,
      row:   20,
      ohp:   20,
      dead:  40,
    };

    const INCREMENTS = {
      default: 2.5,
      dead: 5,
    };

    const STORAGE_KEY_STATE = 'sl5x5_state_v5';

    // repsState: per set (repsLeft, marked)
    let state = {
      currentPass: 'A',
      weights: { ...DEFAULT_WEIGHTS },
      repsState: {}, // { 'A_squat': [ {repsLeft, marked}, ... ] }
    };

    // Global vilotimer (ej persistent)
    let timerActive = false;
    let timerStartTime = null;
    let timerExerciseKey = null; // t.ex. "A_squat"
    let timerIntervalId = null;

    const exerciseListEl = document.getElementById('exercise-list');
    const btnPassA = document.getElementById('btn-pass-a');
    const btnPassB = document.getElementById('btn-pass-b');
    const btnReset = document.getElementById('btn-reset');
    const btnComplete = document.getElementById('btn-complete');
    const globalTimerEl = document.getElementById('global-timer');
    const globalTimerLabelEl = document.getElementById('global-timer-label');
    const globalTimerValueEl = document.getElementById('global-timer-value');

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY_STATE);
        if (raw) {
          const parsed = JSON.parse(raw);
          state = {
            ...state,
            ...parsed,
            weights: { ...DEFAULT_WEIGHTS, ...(parsed.weights || {}) },
            repsState: parsed.repsState || {},
          };
        }
      } catch (e) {
        console.error('Kunde inte läsa state', e);
      }
    }

    function saveState() {
      try {
        localStorage.setItem(STORAGE_KEY_STATE, JSON.stringify(state));
      } catch (e) {
        console.error('Kunde inte spara state', e);
      }
    }

    function getRepsArray(key, ex) {
      if (!state.repsState[key]) {
        state.repsState[key] = Array(ex.sets).fill(null).map(() => ({
          repsLeft: ex.reps,
          marked: false,
        }));
      }
      return state.repsState[key];
    }

    function formatSeconds(sec) {
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      const mm = m.toString().padStart(2, '0');
      const ss = s.toString().padStart(2, '0');
      return `${mm}:${ss}`;
    }

    function updateGlobalTimerDisplay() {
      if (!timerActive || timerStartTime === null || !timerExerciseKey) {
        globalTimerEl.style.display = 'none';
        return;
      }
      const [passId, exId] = timerExerciseKey.split('_');
      const workout = WORKOUTS[passId];
      const ex = workout.find(e => e.id === exId);
      const elapsedSec = Math.floor((Date.now() - timerStartTime) / 1000);
      globalTimerLabelEl.textContent = `Vila – ${ex ? ex.name : ''}`;
      globalTimerValueEl.textContent = formatSeconds(elapsedSec);
      globalTimerEl.style.display = 'flex';
    }

    function startTimerForExercise(exerciseKey) {
      timerExerciseKey = exerciseKey;
      timerStartTime = Date.now();
      timerActive = true;
      updateGlobalTimerDisplay();

      if (timerIntervalId === null) {
        timerIntervalId = setInterval(() => {
          if (!timerActive) {
            clearInterval(timerIntervalId);
            timerIntervalId = null;
            return;
          }
          updateGlobalTimerDisplay();
        }, 1000);
      }
    }

    function stopTimer() {
      timerActive = false;
      timerStartTime = null;
      timerExerciseKey = null;
      updateGlobalTimerDisplay();
      if (timerIntervalId !== null) {
        clearInterval(timerIntervalId);
        timerIntervalId = null;
      }
    }
    function render() {
      btnPassA.classList.toggle('active', state.currentPass === 'A');
      btnPassB.classList.toggle('active', state.currentPass === 'B');

      exerciseListEl.innerHTML = '';
      const workout = WORKOUTS[state.currentPass];

      workout.forEach(ex => {
        const card = document.createElement('div');
        card.className = 'card';

        const header = document.createElement('div');
        header.className = 'card-header';

        const nameEl = document.createElement('div');
        nameEl.className = 'exercise-name';
        nameEl.textContent = ex.name;

        const metaEl = document.createElement('div');
        metaEl.className = 'exercise-meta';
        metaEl.textContent = `${ex.sets}×${ex.reps}`;

        header.appendChild(nameEl);
        header.appendChild(metaEl);

        const weightRow = document.createElement('div');
        weightRow.className = 'weight-row';

        const weightLabel = document.createElement('div');
        weightLabel.className = 'weight-label';
        weightLabel.textContent = 'Vikt (kg)';

        const weightControls = document.createElement('div');
        weightControls.className = 'weight-controls';

        const minusBtn = document.createElement('button');
        minusBtn.className = 'btn-circle';
        minusBtn.textContent = '−';
        minusBtn.addEventListener('click', () => {
          state.weights[ex.id] = Math.max(0, (state.weights[ex.id] || 0) - 2.5);
          saveState();
          render();
        });

        const weightValue = document.createElement('div');
        weightValue.className = 'weight-value';
        weightValue.textContent = (state.weights[ex.id] ?? 0).toFixed(1).replace('.0','');

        const plusBtn = document.createElement('button');
        plusBtn.className = 'btn-circle';
        plusBtn.textContent = '+';
        plusBtn.addEventListener('click', () => {
          state.weights[ex.id] = (state.weights[ex.id] || 0) + 2.5;
          saveState();
          render();
        });

        weightControls.appendChild(minusBtn);
        weightControls.appendChild(weightValue);
        weightControls.appendChild(plusBtn);

        weightRow.appendChild(weightLabel);
        weightRow.appendChild(weightControls);

        const setsRow = document.createElement('div');
        setsRow.className = 'sets-row';

        const key = `${state.currentPass}_${ex.id}`;
        const repsArray = getRepsArray(key, ex);

        repsArray.forEach((setState, index) => {
          const pill = document.createElement('button');
          pill.className = 'set-pill' + (setState.marked ? ' done' : '');
          pill.textContent = setState.repsLeft.toString();

          pill.addEventListener('click', () => {
            const arr = getRepsArray(key, ex);
            const current = arr[index];

            if (!current.marked) {
              // Första klick: markera setet (grön), behåll 5 reps.
              current.marked = true;

              // Starta global timer för denna övning (första setet klart)
              startTimerForExercise(key);
            } else {
              // Nästa klick: minska reps ned till 0
              if (current.repsLeft > 0) {
                current.repsLeft = current.repsLeft - 1;
              }

              // Om övningen inte är helt klar, starta om timern
              const allFinished = arr.every(s => s.marked && s.repsLeft === 0);
              if (!allFinished) {
                startTimerForExercise(key);
              } else {
                // Övningen klar: stoppa timer helt
                stopTimer();
              }
            }

            saveState();
            render();
          });

          setsRow.appendChild(pill);
        });

        card.appendChild(header);
        card.appendChild(weightRow);
        card.appendChild(setsRow);

        exerciseListEl.appendChild(card);
      });

      updateGlobalTimerDisplay();
    }

    function resetSets() {
      const workout = WORKOUTS[state.currentPass];
      workout.forEach(ex => {
        const key = `${state.currentPass}_${ex.id}`;
        delete state.repsState[key];
      });
      stopTimer();
      saveState();
      render();
    }

    function completeWorkout() {
      const workout = WORKOUTS[state.currentPass];
      let allCompleted = true;

      workout.forEach(ex => {
        const key = `${state.currentPass}_${ex.id}`;
        const repsArray = getRepsArray(key, ex);
        if (!repsArray.every(s => s.marked && s.repsLeft === ex.reps)) {
          allCompleted = false;
        }
      });

      if (allCompleted) {
        workout.forEach(ex => {
          const inc = ex.id === 'dead' ? INCREMENTS.dead : INCREMENTS.default;
          state.weights[ex.id] = (state.weights[ex.id] || 0) + inc;
        });
      }

      resetSets();
      state.currentPass = state.currentPass === 'A' ? 'B' : 'A';

      saveState();
      render();
      alert(allCompleted ? 'Pass klart! Alla set hade 5 reps, vikterna har ökats.' : 'Pass slutfört. Något set hade färre än 5 reps, vikter oförändrade.');
    }

    btnPassA.addEventListener('click', () => {
      state.currentPass = 'A';
      stopTimer();
      saveState();
      render();
    });

    btnPassB.addEventListener('click', () => {
      state.currentPass = 'B';
      stopTimer();
      saveState();
      render();
    });

    btnReset.addEventListener('click', () => {
      if (confirm('Återställ alla set för aktuellt pass?')) {
        resetSets();
      }
    });

    btnComplete.addEventListener('click', () => {
      completeWorkout();
    });

    loadState();
    render();

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .catch(err => console.error('SW error', err));
      });
    }
  </script>
</body>
</html>
